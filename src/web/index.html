<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedcube Training Explorer</title>
    <link rel="icon" type="image/png" href="images/favicon_w.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Dark Mode Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;">
            <path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/>
        </svg>
        <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/>
        </svg>
    </button>

    <!-- Persistent Header with Greeting -->
    <header>
        <div class="container">
            <div class="greeting-container">
                <div class="greeting-content">
                    <h1 id="greeting-text">Welcome to Speedcube Training Explorer</h1>
                    <p id="greeting-subtext" class="subtitle">Track your progress and compare with WCA rankings</p>
                </div>
                <div class="greeting-logo">
                    <img src="images/favicon_b.png" alt="Logo" class="logo-light">
                    <img src="images/favicon_w.png" alt="Logo" class="logo-dark">
                </div>
            </div>
            <!-- WCA ID Setup (shown only if no WCA ID set) -->
            <div id="wca-setup-prompt" style="display: none;">
                <button class="btn-secondary" onclick="showWCASetupModal()">
                    Set up WCA ID
                </button>
            </div>
            <!-- WCA ID Display (shown if WCA ID is set) -->
            <div id="wca-display" style="display: none;">
                <span class="wca-id-badge" id="wca-id-display" onclick="showWCASetupModal()" style="cursor: pointer;"></span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        
        <!-- Navigation Tabs -->
        <nav class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('sessions')">Sessions</button>
            <button class="tab" onclick="switchTab('cubes')">Cubes</button>
            <button class="tab" onclick="switchTab('import')">Import</button>
            <button class="tab" onclick="switchTab('charts')">Charts</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
        
        <!-- Stats Dashboard -->
        <section class="dashboard" id="dashboard">
            <div class="section-header">
                <h2>Your Statistics</h2>
                <div class="event-filter">
                    <label for="event-select">Event:</label>
                    <select id="event-select" onchange="changeEvent()">
                        <option value="all">All Events</option>
                        <option value="333" selected>3x3x3</option>
                    </select>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-pb">--</div>
                    <div class="stat-label">Personal Best</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-avg">--</div>
                    <div class="stat-label">Average Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-solves">--</div>
                    <div class="stat-label">Total Solves</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-sessions">--</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cubes">--</div>
                    <div class="stat-label">Total Cubes</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-value" id="stat-rank">--</div>
                    <div class="stat-label">Your World Rank</div>
                    <div class="stat-note">vs WCA competitors</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-value" id="stat-percentile">--</div>
                    <div class="stat-label">Your Percentile</div>
                    <div class="stat-note">Top X% worldwide</div>
                </div>
            </div>
        </section>

        <!-- Recent Sessions -->
        <section class="sessions-section">
            <h2>Recent Sessions</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Event</th>
                            <th>Solves</th>
                            <th>Best</th>
                            <th>Mean</th>
                        </tr>
                    </thead>
                    <tbody id="recent-sessions-tbody">
                        <tr>
                            <td colspan="5" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        </div>

        <!-- Sessions Tab -->
        <div id="tab-sessions" class="tab-content">
            <section class="sessions-section">
                <div class="section-header">
                    <h2>Training Sessions</h2>
                    <button class="btn-primary" onclick="showAddSessionForm()">Add Session</button>
                </div>
                
                <!-- Add Session Form -->
                <div id="add-session-form" class="form-card" style="display: none;">
                    <h3>Add New Session</h3>
                    <form onsubmit="addSession(event)">
                        <div class="form-group">
                            <label>Event Type:</label>
                            <select id="new-event-id" required>
                                <option value="222">2x2x2</option>
                                <option value="333" selected>3x3x3</option>
                                <option value="444">4x4x4</option>
                                <option value="555">5x5x5</option>
                                <option value="666">6x6x6</option>
                                <option value="777">7x7x7</option>
                                <option value="333oh">3x3x3 One-Handed</option>
                                <option value="333bf">3x3x3 Blindfolded</option>
                                <option value="clock">Clock</option>
                                <option value="minx">Megaminx</option>
                                <option value="pyram">Pyraminx</option>
                                <option value="skewb">Skewb</option>
                                <option value="sq1">Square-1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cube (optional):</label>
                            <select id="new-cube-id">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes:</label>
                            <input type="text" id="new-session-notes">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Create Session</button>
                            <button type="button" class="btn-secondary" onclick="hideAddSessionForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Filters will be inserted here by JavaScript -->

                <div class="table-container">
                    <table id="sessions-table">
                        <thead>
                            <tr>
                                <th>Date Imported</th>
                                <th>Event</th>
                                <th>Solves</th>
                                <th>Best</th>
                                <th>Mean</th>
                                <th>Ao5</th>
                                <th>Ao12</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-tbody">
                            <tr>
                                <td colspan="8" class="loading">Loading sessions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Solve Details Modal -->
                <div id="solve-details-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="solve-modal-title">Session Solves</h3>
                            <button class="modal-close" onclick="closeSolveModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- Add Solve Form -->
                            <div class="form-card">
                                <h4>Add Solve</h4>
                                <form onsubmit="addSolveToSession(event)" id="add-solve-form">
                                    <input type="hidden" id="current-session-id">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Time (seconds):</label>
                                            <input type="number" step="0.01" id="new-solve-time" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Penalty:</label>
                                            <select id="new-solve-penalty">
                                                <option value="">None</option>
                                                <option value="+2">+2</option>
                                                <option value="DNF">DNF</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Scramble (optional):</label>
                                        <input type="text" id="new-solve-scramble">
                                    </div>
                                    <button type="submit" class="btn-primary">Add Solve</button>
                                </form>
                            </div>

                            <!-- Solves Table with Sortable Headers -->
                            <table class="solves-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortSolves('number')"># <span class="sort-arrow"></span></th>
                                        <th class="sortable" onclick="sortSolves('time')">Time <span class="sort-arrow"></span></th>
                                        <th class="sortable" onclick="sortSolves('penalty')">Penalty <span class="sort-arrow"></span></th>
                                        <th>Scramble</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="solves-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Cubes Tab -->
        <div id="tab-cubes" class="tab-content">
            <section class="cubes-section">
                <div class="section-header">
                    <h2>Cube Inventory</h2>
                    <button class="btn-primary" onclick="showAddCubeForm()">Add Cube</button>
                </div>

                <!-- Add Cube Form -->
                <div id="add-cube-form" class="form-card" style="display: none;">
                    <h3>Add New Cube</h3>
                    <form onsubmit="addCube(event)">
                        <div class="form-group">
                            <label>Name: <span style="color: red;">*</span></label>
                            <input type="text" id="new-cube-name" required placeholder="e.g., Main 3x3">
                        </div>
                        <div class="form-group">
                            <label>Brand:</label>
                            <input type="text" id="new-cube-brand" placeholder="e.g., GAN, MoYu">
                        </div>
                        <div class="form-group">
                            <label>Model:</label>
                            <input type="text" id="new-cube-model" placeholder="e.g., 14 MagLev">
                        </div>
                        <div class="form-group">
                            <label>Purchase Date / Started Using:</label>
                            <input type="date" id="new-cube-date">
                        </div>
                        <div class="form-group">
                            <label>Notes:</label>
                            <textarea id="new-cube-notes" rows="3" placeholder="Any additional notes..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Add Cube</button>
                            <button type="button" class="btn-secondary" onclick="hideAddCubeForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Edit form will be inserted here by JavaScript -->

                <div class="table-container">
                    <table id="cubes-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Brand</th>
                                <th>Model</th>
                                <th>Purchase Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cubes-tbody">
                            <tr>
                                <td colspan="6" class="loading">Loading cubes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Import Tab -->
        <div id="tab-import" class="tab-content">
        <section class="import-section" id="import">
            <h2>Import Data</h2>
            <div class="import-card">
                <p>Upload your CSTimer export file (.txt, .json)</p>
                <input type="file" id="file-input" accept=".txt,.json" style="display: none;">
                <button class="btn-primary" onclick="document.getElementById('file-input').click()">
                    Choose File
                </button>
                <span id="file-name"></span>
                <button class="btn-secondary" id="preview-btn" style="display: none;">
                    Preview Sessions
                </button>
                <div id="import-status"></div>

                <!-- Session Selection -->
                <div id="session-selection" style="display: none; margin-top: 20px;">
                    <h3>Select Sessions to Import</h3>
                    
                    <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                        <label for="import-event-select">Import as Event:</label>
                        <select id="import-event-select" class="event-select">
                            <option value="222">2x2x2</option>
                            <option value="333" selected>3x3x3</option>
                            <option value="444">4x4x4</option>
                            <option value="555">5x5x5</option>
                            <option value="666">6x6x6</option>
                            <option value="777">7x7x7</option>
                            <option value="333oh">3x3x3 One-Handed</option>
                            <option value="333bf">3x3x3 Blindfolded</option>
                            <option value="clock">Clock</option>
                            <option value="minx">Megaminx</option>
                            <option value="pyram">Pyraminx</option>
                            <option value="skewb">Skewb</option>
                            <option value="sq1">Square-1</option>
                        </select>
                    </div>
                    
                    <div id="session-checkboxes"></div>
                    <div style="margin-top: 20px;">
                        <button class="btn-primary" onclick="importSelectedSessions()">Import Selected</button>
                        <button class="btn-secondary" onclick="cancelImport()">Cancel</button>
                    </div>
                </div>
            </div>
        </section>
        </div>

        <!-- Charts Tab -->
        <div id="tab-charts" class="tab-content">
            <section class="charts-section" id="charts">
                <h2>Progress Analysis</h2>
                
                <!-- Event & Session selectors inserted by JavaScript -->
                
                <div class="chart-card">
                    <h3>Training Progress Over Time</h3>
                    <div id="progress-chart" class="chart-container">
                        <div class="loading">Loading chart...</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Solve Time Distribution</h3>
                    <div id="distribution-chart" class="chart-container">
                        <div class="loading">Loading chart...</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Rolling Averages (Ao5 & Ao12)</h3>
                    <div id="breakdown-chart" class="chart-container">
                        <div class="loading">Loading chart...</div>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Consistency Across Sessions</h3>
                    <div id="consistency-chart" class="chart-container">
                        <div class="loading">Loading chart...</div>
                    </div>
                </div>
            </section>
        </div>
    
        <!-- WCA ID Setup Modal -->
        <div id="wca-setup-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>Set Up Your WCA ID</h3>
                    <button class="modal-close" onclick="closeWCASetupModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Enter your WCA ID to personalize your dashboard. We'll fetch your name from the official WCA database.
                    </p>
                    <form onsubmit="saveWCAID(event)">
                        <div class="form-group">
                            <label>WCA ID:</label>
                            <input 
                                type="text" 
                                id="wca-id-input" 
                                placeholder="e.g., 2003POCH01"
                                pattern="[0-9]{4}[A-Z]{4}[0-9]{2}"
                                title="WCA ID format: 2003POCH01"
                                required
                            >
                            <small style="color: var(--text-tertiary); display: block; margin-top: 4px;">
                                Format: YYYYLLLL## (e.g., 2003POCH01)
                            </small>
                        </div>
                        <div id="wca-setup-status"></div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Save WCA ID</button>
                            <button type="button" class="btn-secondary" onclick="closeWCASetupModal()">Cancel</button>
                            <button type="button" class="btn-secondary" id="remove-wca-btn" onclick="removeWCAID()" style="display: none; margin-left: auto;">
                                Remove
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>Speedcube Training Explorer</p>
            <p class="footer-links">
                <a href="https://github.com/havl-code/speedcube-training-explorer" target="_blank">GitHub</a>
                <span>|</span>
                <a href="https://github.com/robiningelbrecht/wca-rest-api" target="_blank">WCA API</a>
            </p>
            <p class="footer-credit">Created by Viet Ha Ly</p>
        </div>
    </footer>

    <!-- Load JavaScript modules in order -->
    <script src="js/config.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/sessions.js"></script>
    <script src="js/cubes.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/import.js"></script>
    <script src="js/greeting.js"></script>
    <script src="js/app.js"></script>
    <script src="js/theme.js"></script>
</body>
</html>